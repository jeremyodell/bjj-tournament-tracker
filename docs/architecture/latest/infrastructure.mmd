%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#FF9900', 'primaryTextColor': '#232F3E', 'primaryBorderColor': '#232F3E', 'lineColor': '#6B7280', 'secondaryColor': '#10B981', 'tertiaryColor': '#3B82F6' }}}%%

flowchart TB
    subgraph Internet["ðŸŒ Internet"]
        Users["ðŸ‘¥ Users"]
        DNS["ðŸ“¡ DNS\nbjjcomps.com"]
    end

    subgraph Vercel["â˜ï¸ Vercel"]
        direction TB
        CDN["ðŸš€ Edge Network\nGlobal CDN"]
        NextApp["âš›ï¸ Next.js 15\nApp Router + SSR"]
        VercelEnv["ðŸ”‘ Env Variables\nCognito, API URLs"]
    end

    subgraph AWSRegion["â˜ï¸ AWS us-east-1"]
        subgraph VPC["ðŸ”’ Default VPC"]
            subgraph APIGateway["ðŸ“¡ API Gateway"]
                RestAPI["REST API\nbjj-tournament-tracker-api-{stage}"]
                WebSocketAPI["WebSocket API\nbjj-websocket-{stage}"]
                CorsConfig["CORS: Allow *"]
                RateLimiting["Rate Limit: 60/sec\nBurst: 100"]
            end

            subgraph Cognito["ðŸ” AWS Cognito"]
                UserPool["User Pool\nbjj-tournament-tracker-users-{stage}"]
                ClientApp["App Client\nNo Secret (SPA)"]
                HostedUI["Hosted UI\nOAuth Flows"]
                GoogleIdP["Google Identity Provider"]
            end

            subgraph Compute["âš¡ Lambda Functions (Node.js 20)"]
                TournamentsFn["ðŸ“… tournaments\n256MB / 30s"]
                SyncFn["ðŸ”„ sync\n1536MB / 180s\nMakefile Build"]
                WishlistFn["â¤ï¸ wishlist\n256MB / 30s"]
                AthletesFn["ðŸ¥‹ athletes\n256MB / 30s"]
                FlightPricesFn["âœˆï¸ flight-prices\n256MB / 30s"]
                AirportsFn["ðŸ›« airports\n256MB / 30s"]
                WebSocketFn["ðŸ”Œ websocket\n256MB / 30s"]
                FlightFetcherFn["ðŸ“Š flight-fetcher\n512MB / 300s"]
            end

            subgraph Storage["ðŸ—„ï¸ Storage"]
                DynamoDB["DynamoDB\nbjj-tournament-tracker-{stage}\nPAY_PER_REQUEST\nTTL Enabled"]
                GSI1["GSI1 Index\nAlternate Access Patterns"]
            end

            subgraph EventDriven["ðŸ“¬ Event-Driven (Conditional)"]
                EventBus["EventBridge\nbjj-flight-prices-{stage}"]
                FlightQueue["SQS Queue\n5min visibility\n24h retention"]
                FlightDLQ["Dead Letter Queue\n14d retention"]
                DailyRule["Daily CRON\n4 AM UTC"]
                AirportRule["Event Rule\nairport.added"]
            end
        end

        subgraph Monitoring["ðŸ“Š Monitoring (Prod Only)"]
            TournamentAlarm["CloudWatch Alarm\ntournaments errors"]
            SyncAlarm["CloudWatch Alarm\nsync errors"]
        end
    end

    subgraph ExternalServices["ðŸŒ External Services"]
        IBJJFSite["IBJJF.com\nCalendar API"]
        JJWLSite["JJWorldLeague.com\nEvents API"]
        AmadeusAPI["Amadeus API\nFlight Search"]
        GoogleMapsAPI["Google Maps API\nGeocoding"]
        GoogleOAuth["Google OAuth\nIdentity Provider"]
    end

    %% User Flow
    Users --> DNS
    DNS --> CDN
    CDN --> NextApp
    NextApp --> VercelEnv

    %% Frontend to AWS
    NextApp --> RestAPI
    NextApp --> WebSocketAPI
    NextApp --> UserPool

    %% API Gateway to Lambda
    RestAPI --> TournamentsFn
    RestAPI --> WishlistFn
    RestAPI --> AthletesFn
    RestAPI --> FlightPricesFn
    RestAPI --> AirportsFn
    WebSocketAPI --> WebSocketFn

    %% Auth
    UserPool --> ClientApp
    ClientApp --> HostedUI
    HostedUI --> GoogleIdP
    GoogleIdP --> GoogleOAuth
    UserPool -.->|JWT Auth| RestAPI

    %% Lambda to Storage
    TournamentsFn --> DynamoDB
    SyncFn --> DynamoDB
    WishlistFn --> DynamoDB
    AthletesFn --> DynamoDB
    FlightPricesFn --> DynamoDB
    WebSocketFn --> DynamoDB
    FlightFetcherFn --> DynamoDB
    DynamoDB --> GSI1

    %% Sync External
    SyncFn --> IBJJFSite
    SyncFn --> JJWLSite
    SyncFn --> GoogleMapsAPI

    %% Event-Driven Flight Prices
    AirportsFn --> EventBus
    EventBus --> FlightQueue
    DailyRule --> FlightQueue
    AirportRule --> FlightQueue
    FlightQueue --> FlightFetcherFn
    FlightQueue --> FlightDLQ
    FlightFetcherFn --> AmadeusAPI
    FlightFetcherFn --> WebSocketAPI

    %% Monitoring
    TournamentsFn --> TournamentAlarm
    SyncFn --> SyncAlarm

    %% Styling
    classDef vercel fill:#000,stroke:#fff,color:#fff
    classDef aws fill:#FF9900,stroke:#232F3E,color:#232F3E
    classDef lambda fill:#FF9900,stroke:#232F3E,color:#000
    classDef dynamo fill:#4053D6,stroke:#2D3748,color:#fff
    classDef cognito fill:#DD344C,stroke:#8B0000,color:#fff
    classDef external fill:#10B981,stroke:#059669,color:#fff
    classDef events fill:#FF4F8B,stroke:#C41E3A,color:#fff

    class CDN,NextApp,VercelEnv vercel
    class RestAPI,WebSocketAPI,CorsConfig,RateLimiting aws
    class TournamentsFn,SyncFn,WishlistFn,AthletesFn,FlightPricesFn,AirportsFn,WebSocketFn,FlightFetcherFn lambda
    class DynamoDB,GSI1 dynamo
    class UserPool,ClientApp,HostedUI,GoogleIdP cognito
    class IBJJFSite,JJWLSite,AmadeusAPI,GoogleMapsAPI,GoogleOAuth external
    class EventBus,FlightQueue,FlightDLQ,DailyRule,AirportRule events
